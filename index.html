<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspadinha Fornalle</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap');
        :root { --laranja: #ff9f5e; --bege: #fbd38d; --vinho: #800000; --cinza: #333; }
        
        body { 
            font-family: 'Oswald', sans-serif; 
            margin: 0; 
            text-transform: uppercase; 
            background-color: var(--laranja); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-x: hidden; /* Evita barra de rolagem lateral se o confete sair um pouco */
        }

        .logo { font-size: 3rem; color: white; text-align: center; line-height: 0.8; padding: 30px 0; width: 100%; }
        .logo span { font-size: 1rem; display: block; margin-top: 10px; color: #ff0000; -webkit-text-stroke: 0.5px black; letter-spacing: 3px; }

        .container-tela { display: none; width: 100%; max-width: 400px; flex-direction: column; align-items: center; padding: 0 20px 40px 20px; box-sizing: border-box; }
        
        .form-container { 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            width: 100%; 
            color: var(--cinza); 
            text-transform: none; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }

        input { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; font-family: Arial; }
        
        .grid-premios { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .btn-admin { background: white; border: 2px solid var(--cinza); padding: 12px; cursor: pointer; font-family: 'Oswald'; font-weight: bold; border-radius: 8px; width: 100%; }
        
        .caixa-link { background: #eee; padding: 15px; border-radius: 8px; word-break: break-all; width: 100%; text-align: center; font-size: 0.8rem; border: 1px dashed var(--cinza); text-transform: none; margin: 15px 0; color: var(--cinza); box-sizing: border-box; }
        
        .scratch-container { position: relative; width: 280px; height: 280px; background: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 5px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.2); margin-bottom: 20px; }
        #premio-texto { color: var(--cinza); font-size: 1.5rem; text-align: center; padding: 10px; font-weight: bold; width: 100%; line-height: 1.2; }
        canvas { position: absolute; top: 0; left: 0; border-radius: 10px; cursor: crosshair; touch-action: none; }
        
        .btn-enviar { width: 100%; background: var(--cinza); color: white; border: none; padding: 18px; border-radius: 8px; cursor: pointer; font-family: 'Oswald'; font-size: 1.2rem; }
        .btn-reg { background-color: var(--vinho); color: white; border: none; padding: 12px 30px; border-radius: 30px; cursor: pointer; font-family: 'Oswald'; font-weight: bold; border: 2px solid white; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { background: white; color: var(--cinza); padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-transform: none; font-family: Arial, sans-serif; }
        .regra-box { border-bottom: 1px solid #eee; padding: 12px 0; font-size: 0.95rem; line-height: 1.4; }
        .regra-box b { color: var(--vinho); display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div class="logo">FORNALLE<span>PIZZA DELIVERY</span></div>

    <div id="painel-admin" class="container-tela">
        <h2 style="color:white; margin-bottom:15px;">GERADOR DE LINKS</h2>
        <div class="grid-premios">
            <button class="btn-admin" onclick="gerarLink(1)">Pizza R$32</button>
            <button class="btn-admin" onclick="gerarLink(2)">Borda Gr√°tis</button>
            <button class="btn-admin" onclick="gerarLink(3)">Pastel R$12</button>
            <button class="btn-admin" onclick="gerarLink(4)">Panzerotti R$12</button>
            <button class="btn-admin" onclick="gerarLink(5)">Refri 200ml</button>
            <button class="btn-admin" onclick="gerarLink(6)">Desconto R$5,00</button>
            <button class="btn-admin" onclick="gerarLink(8)">Desconto R$3,00</button>
            <button class="btn-admin" onclick="gerarLink(9)">Desconto R$2,00</button>
            <button class="btn-admin" onclick="gerarLink(7)">Entrega Gr√°tis</button>
            <button class="btn-admin" onclick="gerarLink(0)" style="background:#ffcccc;">Sem Pr√™mio</button>
        </div>
        <div id="caixa-link" class="caixa-link">Escolha um pr√™mio acima</div>
        <button onclick="copiarLink()" class="btn-enviar" style="background:white; color:#333;">COPIAR LINK</button>
    </div>

    <div id="tela-cadastro" class="container-tela">
        <div class="form-container">
            <h2 style="text-align:center; color:var(--laranja); margin:0;">VALIDAR ACESSO</h2>
            <p style="text-align:center; margin:0; font-size:0.85rem; font-family: Arial;">Identifique-se para liberar seu pr√™mio</p>
            <input type="tel" id="cpf" placeholder="SEU CPF (Somente n√∫meros)">
            <div id="campos-extras" style="display:none; flex-direction: column; gap: 12px;">
                <input type="text" id="nome" placeholder="NOME COMPLETO">
                <input type="tel" id="whats" placeholder="WHATSAPP COM DDD">
            </div>
            <button id="btn-acao" class="btn-enviar" onclick="fluxo()">CONTINUAR</button>
        </div>
    </div>

    <div id="tela-cliente" class="container-tela">
        <div class="scratch-container">
            <div id="premio-texto">Sorteando...</div>
            <canvas id="scratchCanvas" width="280" height="280"></canvas>
        </div>
        <button class="btn-reg" onclick="document.getElementById('meuModal').style.display='flex'">VER REGULAMENTO</button>
    </div>

    <div id="meuModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--vinho); border-bottom: 2px solid var(--laranja); padding-bottom: 10px; text-align: center; margin-top: 0;">üìù REGRAS DE RESGATE</h3>
            <div style="max-height: 350px; overflow-y: auto;">
                <div class="regra-box"><b>üìÖ VALIDADE:</b> O pr√™mio expira em 7 dias corridos ap√≥s a raspagem.</div>
                <div class="regra-box"><b>üí∞ PEDIDO M√çNIMO:</b> V√°lido para pedidos acima de R$ 29,90 (exceto taxa de entrega).</div>
                <div class="regra-box"><b>üö´ N√ÉO CUMULATIVO:</b> N√£o acumul√°vel com outros cupons ou pizzas em promo√ß√£o.</div>
                <div class="regra-box"><b>üë§ USO PESSOAL:</b> Vinculado ao seu CPF, intransfer√≠vel e limitado a um pr√™mio por campanha.</div>
                <div class="regra-box"><b>üì≤ RESGATE:</b> Informe o seu CPF ao atendente no momento do pedido via WhatsApp.</div>
                <p style="font-size: 0.75rem; color: #888; margin-top: 15px; font-style: italic; font-family: Arial;">*A Fornalle Pizza reserva-se o direito de encerrar esta a√ß√£o promocional a qualquer momento.</p>
            </div>
            <button class="btn-enviar" onclick="this.parentElement.parentElement.style.display='none'">LI E CONCORDO</button>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycby4GVvfYI9UYfOAck2Ric2qlEovg3JT7QUQqGJ8XOKHlj70YTJ6OPB086ii1Cp3cRV6/exec';
        const SENHA_MESTRA = "paodoce1530";
        let premioGlobal = "";
        let modoAtualizar = false;
        let confeteJaSolto = false; // Vari√°vel para controlar se o confete j√° foi disparado

        const tabelaPremios = {
            1: "Vale uma pizza de R$32,00",
            2: "Borda Recheada Gr√°tis",
            3: "Pastel de R$12,00 Gr√°tis",
            4: "Panzerotti de R$12,00 Gr√°tis",
            5: "Refri 200ml Gr√°tis",
            6: "R$5,00 de Desconto",
            7: "Entrega Gr√°tis",
            8: "R$3,00 de Desconto",
            9: "R$2,00 de Desconto",
            0: "N√ÉO FOI DESTA VEZ! üçï"
        };

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const p = params.get('p');
            if (p !== null && tabelaPremios[p] !== undefined) {
                document.getElementById('tela-cadastro').style.display = 'flex';
                premioGlobal = tabelaPremios[p];
            } else {
                let s = prompt("Senha Admin:");
                if (s === SENHA_MESTRA) document.getElementById('painel-admin').style.display = 'flex';
                else window.location.reload();
            }
        };

        function fluxo() {
            const cpf = document.getElementById('cpf').value;
            if(!cpf || cpf.length < 11) return alert("Digite um CPF v√°lido.");
            
            if(document.getElementById('campos-extras').style.display === 'none') {
                document.getElementById('btn-acao').innerText = "VERIFICANDO...";
                fetch(`${scriptURL}?acao=verificar&cpf=${cpf}`).then(r => r.text()).then(res => {
                    if(res === "existe") {
                        modoAtualizar = true;
                        enviarDados();
                    } else {
                        document.getElementById('campos-extras').style.display = 'flex';
                        document.getElementById('btn-acao').innerText = "CADASTRAR E RASPAR";
                    }
                });
            } else {
                enviarDados();
            }
        }

        function enviarDados() {
            const cpf = document.getElementById('cpf').value;
            const nome = document.getElementById('nome').value || "Cliente Repetido";
            const whats = document.getElementById('whats').value || "J√° Cadastrado";
            
            if(!modoAtualizar && (!document.getElementById('nome').value || !document.getElementById('whats').value)) {
                return alert("Preencha Nome e WhatsApp!");
            }

            document.getElementById('btn-acao').innerText = "PROCESSANDO...";
            fetch(`${scriptURL}?nome=${encodeURIComponent(nome)}&cpf=${cpf}&whatsapp=${whats}&premio=${encodeURIComponent(premioGlobal)}`,{mode:'no-cors'})
            .then(() => entrar());
        }

        function entrar() {
            document.getElementById('tela-cadastro').style.display = 'none';
            document.getElementById('tela-cliente').style.display = 'flex';
            document.getElementById('premio-texto').innerText = premioGlobal;
            const cv = document.getElementById('scratchCanvas');
            const cx = cv.getContext('2d');
            
            // Reseta estado do confete
            confeteJaSolto = false;

            cx.fillStyle = '#999'; cx.fillRect(0,0,280,280);
            cx.fillStyle = 'white'; cx.font = 'bold 20px Oswald'; cx.textAlign = 'center';
            cx.fillText('RASPE AQUI COM O DEDO', 140, 140);
            
            let m = false;
            let contadorRaspagem = 0; // Contador para otimizar a verifica√ß√£o

            const raspar = (e) => {
                if(!m) return;
                const rect = cv.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                cx.globalCompositeOperation = 'destination-out';
                cx.beginPath(); cx.arc(x,y,35,0,6.28); cx.fill();

                 // Verifica se j√° raspou o suficiente a cada 15 movimentos (para n√£o travar o celular)
                contadorRaspagem++;
                if (contadorRaspagem % 15 === 0) {
                    verificarPorcentagemRaspada(cx, cv.width, cv.height);
                }
            };
            cv.onmousedown = () => m=true; cv.onmouseup = () => m=false; cv.onmousemove = raspar;
            cv.ontouchstart = (e) => { m=true; e.preventDefault(); }; cv.ontouchend = () => m=false; cv.ontouchmove = raspar;
        }

        // Fun√ß√£o que calcula quantos % j√° foi raspado
        function verificarPorcentagemRaspada(cx, width, height) {
            if (confeteJaSolto) return; // Se j√° soltou, n√£o verifica mais

            // Obt√©m os dados dos pixels do canvas
            const imageData = cx.getImageData(0, 0, width, height);
            const pixels = imageData.data;
            let pixelsTransparentes = 0;

            // Percorre os pixels (a cada 4 valores temos R, G, B, Alpha)
            for (let i = 3; i < pixels.length; i += 4) {
                // Se o canal Alpha (transpar√™ncia) for 0, o pixel est√° transparente
                if (pixels[i] === 0) {
                    pixelsTransparentes++;
                }
            }

            const totalPixels = width * height;
            const porcentagem = (pixelsTransparentes / totalPixels) * 100;

            // Se raspou mais de 50%, solta os confetes
            if (porcentagem > 50) {
                soltarConfete();
                confeteJaSolto = true;
                // Opcional: Remove o canvas para revelar totalmente o pr√™mio
                // document.getElementById('scratchCanvas').style.display = 'none'; 
            }
        }

        // Fun√ß√£o para disparar o efeito de confete
        function soltarConfete() {
            var duration = 3 * 1000; // Dura√ß√£o de 3 segundos
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                var particleCount = 50 * (timeLeft / duration);
                
                // Cores da Fornalle (Vinho, Laranja, Bege)
                var coresConfete = ['#800000', '#ff9f5e', '#fbd38d', '#ffffff'];

                // Lan√ßa confetes de dois lados da tela
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }, colors: coresConfete }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }, colors: coresConfete }));
            }, 250);
        }

        function gerarLink(id) {
            const base = window.location.href.split('?')[0];
            document.getElementById('caixa-link').innerText = base + "?p=" + id;
        }

        function copiarLink() {
            const t = document.getElementById('caixa-link').innerText;
            if(t.includes("Escolha")) return alert("Gere o link primeiro!");
            navigator.clipboard.writeText(t);
            alert("Copiado com sucesso!");
        }
    </script>
</body>
</html>