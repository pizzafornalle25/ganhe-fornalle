<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspadinha Fornalle</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap');
        :root { --laranja: #ff9f5e; --bege: #fbd38d; --vinho: #800000; --cinza: #333; }
        
        body { font-family: 'Oswald', sans-serif; margin: 0; text-transform: uppercase; background-color: var(--laranja); display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        .logo { font-size: 3rem; color: white; text-align: center; line-height: 0.8; padding: 30px 0; width: 100%; }
        .logo span { font-size: 1rem; display: block; margin-top: 10px; color: #ff0000; -webkit-text-stroke: 0.5px black; letter-spacing: 3px; }
        .container-tela { display: none; width: 100%; max-width: 400px; flex-direction: column; align-items: center; padding: 0 20px 40px 20px; box-sizing: border-box; }
        .form-container { background: white; padding: 25px; border-radius: 15px; width: 100%; color: var(--cinza); text-transform: none; box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 12px; }
        input { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; font-family: Arial; }
        .grid-premios { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .btn-admin { background: white; border: 2px solid var(--cinza); padding: 12px; cursor: pointer; font-family: 'Oswald'; font-weight: bold; border-radius: 8px; width: 100%; }
        .caixa-link { background: #eee; padding: 15px; border-radius: 8px; word-break: break-all; width: 100%; text-align: center; font-size: 0.8rem; border: 1px dashed var(--cinza); text-transform: none; margin: 15px 0; color: var(--cinza); box-sizing: border-box; }
        .scratch-container { position: relative; width: 280px; height: 280px; background: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 5px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.2); margin-bottom: 20px; }
        #premio-texto { color: var(--cinza); font-size: 1.5rem; text-align: center; padding: 10px; font-weight: bold; width: 100%; line-height: 1.2; }
        canvas { position: absolute; top: 0; left: 0; border-radius: 10px; cursor: crosshair; touch-action: none; }
        .btn-enviar { width: 100%; background: var(--cinza); color: white; border: none; padding: 18px; border-radius: 8px; cursor: pointer; font-family: 'Oswald'; font-size: 1.2rem; }
        .btn-reg { background-color: var(--vinho); color: white; border: none; padding: 12px 30px; border-radius: 30px; cursor: pointer; font-family: 'Oswald'; font-weight: bold; border: 2px solid white; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { background: white; color: var(--cinza); padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-transform: none; font-family: Arial, sans-serif; }
        .regra-box { border-bottom: 1px solid #eee; padding: 12px 0; font-size: 0.95rem; line-height: 1.4; }
        .regra-box b { color: var(--vinho); display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div class="logo">FORNALLE<span>PIZZA DELIVERY</span></div>

    <div id="painel-admin" class="container-tela">
        <h2 style="color:white; margin-bottom:15px;">GERADOR DE LINKS</h2>
        <div class="grid-premios">
            <button class="btn-admin" onclick="gerarLink(1)">Pizza R$32</button>
            <button class="btn-admin" onclick="gerarLink(2)">Borda Gr√°tis</button>
            <button class="btn-admin" onclick="gerarLink(3)">Pastel R$12</button>
            <button class="btn-admin" onclick="gerarLink(4)">Panzerotti R$12</button>
            <button class="btn-admin" onclick="gerarLink(5)">Refri 200ml</button>
            <button class="btn-admin" onclick="gerarLink(6)">Desconto R$5,00</button>
            <button class="btn-admin" onclick="gerarLink(8)">Desconto R$3,00</button>
            <button class="btn-admin" onclick="gerarLink(9)">Desconto R$2,00</button>
            <button class="btn-admin" onclick="gerarLink(7)">Entrega Gr√°tis</button>
            <button class="btn-admin" onclick="gerarLink(0)" style="background:#ffcccc;">Sem Pr√™mio</button>
        </div>
        <div id="caixa-link" class="caixa-link">Escolha um pr√™mio acima</div>
        <button onclick="copiarLink()" class="btn-enviar" style="background:white; color:#333;">COPIAR LINK</button>
    </div>

    <div id="tela-cadastro" class="container-tela">
        <div class="form-container">
            <h2 style="text-align:center; color:var(--laranja); margin:0;">VALIDAR ACESSO</h2>
            <p style="text-align:center; margin:0; font-size:0.85rem; font-family: Arial;">Identifique-se para liberar seu pr√™mio</p>
            <input type="tel" id="cpf" placeholder="SEU CPF (Somente n√∫meros)">
            <div id="campos-extras" style="display:none; flex-direction: column; gap: 12px;">
                <input type="text" id="nome" placeholder="NOME COMPLETO">
                <input type="tel" id="whats" placeholder="WHATSAPP COM DDD">
            </div>
            <button id="btn-acao" class="btn-enviar" onclick="fluxo()">CONTINUAR</button>
        </div>
    </div>

    <div id="tela-cliente" class="container-tela">
        <div class="scratch-container">
            <div id="premio-texto">Sorteando...</div>
            <canvas id="scratchCanvas" width="280" height="280"></canvas>
        </div>
        <button class="btn-reg" onclick="document.getElementById('meuModal').style.display='flex'">VER REGULAMENTO</button>
    </div>

    <div id="meuModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--vinho); border-bottom: 2px solid var(--laranja); padding-bottom: 10px; text-align: center; margin-top: 0;">üìù REGRAS DE RESGATE</h3>
            <div style="max-height: 350px; overflow-y: auto;">
                <div class="regra-box"><b>üìÖ VALIDADE:</b> O pr√™mio expira em 7 dias corridos.</div>
                <div class="regra-box"><b>üí∞ PEDIDO M√çNIMO:</b> Consulte valor no WhatsApp.</div>
                <div class="regra-box"><b>üë§ USO PESSOAL:</b> Vinculado ao seu CPF.</div>
            </div>
            <button class="btn-enviar" onclick="this.parentElement.parentElement.style.display='none'">ENTENDI</button>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycby4GVvfYI9UYfOAck2Ric2qlEovg3JT7QUQqGJ8XOKHlj70YTJ6OPB086ii1Cp3cRV6/exec';
        const SENHA_MESTRA = "paodoce1530";
        let premioGlobal = "";
        let confeteJaSolto = false;

        const tabelaPremios = {
            1: "Vale uma pizza de R$32,00", 2: "Borda Recheada Gr√°tis",
            3: "Pastel de R$12,00 Gr√°tis", 4: "Panzerotti de R$12,00 Gr√°tis",
            5: "Refri 200ml Gr√°tis", 6: "R$5,00 de Desconto",
            7: "Entrega Gr√°tis", 8: "R$3,00 de Desconto",
            9: "R$2,00 de Desconto", 0: "N√ÉO FOI DESTA VEZ! üçï"
        };

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const p = params.get('p');

            // SE N√ÉO TEM PR√äMIO NO LINK: √â ACESSO ADMIN
            if (p === null) {
                let s = prompt("Senha Admin:");
                if (s === SENHA_MESTRA) {
                    document.getElementById('painel-admin').style.display = 'flex';
                } else {
                    alert("Acesso negado.");
                    window.location.reload();
                }
                return;
            }

            // SE J√Å JOGOU: APENAS AVISA E N√ÉO REDIRECIONA
            if (localStorage.getItem('raspou_fornalle_2026')) {
                alert("Voc√™ j√° participou desta promo√ß√£o hoje!");
                // N√£o faz nada, a p√°gina ficar√° bloqueada/vazia.
                return;
            }

            // SE TUDO OK: MOSTRA CADASTRO
            if (tabelaPremios[p] !== undefined) {
                document.getElementById('tela-cadastro').style.display = 'flex';
                premioGlobal = tabelaPremios[p];
            }
        };

        function fluxo() {
            const cpf = document.getElementById('cpf').value;
            if(!cpf || cpf.length < 11) return alert("CPF inv√°lido.");
            
            document.getElementById('btn-acao').innerText = "VERIFICANDO...";
            
            fetch(`${scriptURL}?acao=verificar&cpf=${cpf}`)
                .then(r => r.text())
                .then(res => {
                    if(res === "existe") {
                        // CLIENTE ANTIGO: Pula direto
                        enviarDadosOmitidos(cpf);
                    } else {
                        // NOVO CLIENTE: Mostra campos
                        document.getElementById('campos-extras').style.display = 'flex';
                        document.getElementById('btn-acao').innerText = "CADASTRAR E RASPAR";
                        if(document.getElementById('nome').value && document.getElementById('whats').value) enviarDados();
                    }
                });
        }

        function enviarDadosOmitidos(cpf) {
            fetch(`${scriptURL}?nome=Recorrente&cpf=${cpf}&whatsapp=Ja_Cadastrado&premio=${encodeURIComponent(premioGlobal)}`,{mode:'no-cors'})
            .then(() => entrar());
        }

        function enviarDados() {
            const cpf = document.getElementById('cpf').value;
            const nome = document.getElementById('nome').value;
            const whats = document.getElementById('whats').value;
            if(!nome || !whats) return alert("Preencha tudo!");

            fetch(`${scriptURL}?nome=${encodeURIComponent(nome)}&cpf=${cpf}&whatsapp=${whats}&premio=${encodeURIComponent(premioGlobal)}`,{mode:'no-cors'})
            .then(() => entrar());
        }

        function entrar() {
            localStorage.setItem('raspou_fornalle_2026', 'true');
            document.getElementById('tela-cadastro').style.display = 'none';
            document.getElementById('tela-cliente').style.display = 'flex';
            document.getElementById('premio-texto').innerText = premioGlobal;
            
            const cv = document.getElementById('scratchCanvas');
            const cx = cv.getContext('2d');
            cx.fillStyle = '#999'; cx.fillRect(0,0,280,280);
            cx.fillStyle = 'white'; cx.font = 'bold 18px Oswald'; cx.textAlign = 'center';
            cx.fillText('RASPE AQUI', 140, 140);
            
            let m = false;
            const raspar = (e) => {
                if(!m) return;
                const rect = cv.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                cx.globalCompositeOperation = 'destination-out';
                cx.beginPath(); cx.arc(x,y,35,0,6.28); cx.fill();
                verificarRaspagem(cx, cv.width, cv.height);
            };
            cv.onmousedown = () => m=true; cv.onmouseup = () => m=false; cv.onmousemove = raspar;
            cv.ontouchstart = (e) => { m=true; e.preventDefault(); }; cv.ontouchend = () => m=false; cv.ontouchmove = raspar;
        }

        function verificarRaspagem(cx, w, h) {
            if (confeteJaSolto) return;
            const data = cx.getImageData(0, 0, w, h).data;
            let trans = 0;
            for (let i = 3; i < data.length; i += 4) if (data[i] === 0) trans++;
            
            // CONFETE COM 20% RASPADO
            if ((trans / (w * h)) > 0.20) {
                confeteJaSolto = true;
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#800000', '#ff9f5e', '#fbd38d'] });
            }
        }

function gerarLink(id) {
            // Pega a URL base (ex: http://seusite.com/index.html)
            const base = window.location.href.split('?')[0];
            
            // Gera um c√≥digo aleat√≥rio de 6 caracteres para tornar o link √∫nico
            const tokenUnico = Math.random().toString(36).substring(2, 8);
            
            // Monta o link com o pr√™mio (p) e o token (t)
            const linkFinal = `${base}?p=${id}&t=${tokenUnico}`;
            
            // Exibe na caixa para voc√™ copiar
            document.getElementById('caixa-link').innerText = linkFinal;
            
            // Pequeno feedback visual no bot√£o para saber que mudou
            console.log("Link √∫nico gerado: " + tokenUnico);
        }

        function copiarLink() {
            const link = document.getElementById('caixa-link').innerText;
            if(link.includes("Escolha")) return alert("Gere o link primeiro!");
            
            navigator.clipboard.writeText(link).then(() => {
                alert("Link √önico Copiado! Voc√™ j√° pode enviar.");
            });
        }
    </script>
</body>
</html>